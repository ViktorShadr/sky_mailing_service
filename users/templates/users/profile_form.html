<!-- profile_form.html -->
{% extends 'mailing/base.html' %}
{% block title %}Редактирование профиля — SkyMailing{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">

    <h2 class="mb-4">Редактирование профиля</h2>

    <form method="post" enctype="multipart/form-data" class="border rounded p-4 shadow-sm bg-white">
        {% csrf_token %}

        {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Исправьте ошибки ниже:</strong>
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="mb-3">
            {{ form.as_p }}
        </div>

        <!-- Текущее фото аватара -->
        {% if user.avatar %}
            <div class="mb-3">
                <label class="form-label fw-bold">Текущий аватар:</label><br>
                <img src="{{ user.avatar.url }}"
                     alt="avatar"
                     class="img-thumbnail mt-2"
                     style="max-width: 200px;">
            </div>

            <!-- Чекбокс удаления текущего аватара -->
            {% if form.avatar.field.widget.input_type == "file" %}
                <div class="form-check mb-4">
                    <input type="checkbox" name="clear_avatar" id="clear_avatar" class="form-check-input">
                    <label for="clear_avatar" class="form-check-label">
                        Удалить текущий аватар
                    </label>
                </div>
            {% endif %}
        {% endif %}

        <!-- Превью нового изображения -->
        <div class="mb-3" id="previewBlock" style="display: none;">
            <label class="form-label fw-bold">Предпросмотр нового аватара:</label><br>
            <img id="preview" class="img-thumbnail mt-2" style="max-width: 200px;">
            <button type="button" id="clearSelected" class="btn btn-sm btn-outline-danger mt-2">
                Убрать выбранный файл
            </button>
        </div>

        <button type="submit" class="btn btn-primary mt-3 w-100">
            Сохранить изменения
        </button>

        <button type="button" class="btn btn-secondary mt-3 w-100"
                onclick="window.location.href='{% url 'users:profile_detail' %}'">
            Назад
        </button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const fileInput = document.querySelector('input[type="file"][name="avatar"]');
    const previewBlock = document.getElementById("previewBlock");
    const preview = document.getElementById("preview");
    const clearBtn = document.getElementById("clearSelected");
    const clearCheckbox = document.getElementById("clear_avatar");

    if (fileInput) {
        fileInput.addEventListener("change", event => {
            const file = event.target.files[0];

            if (!file) {
                previewBlock.style.display = "none";
                return;
            }

            if (clearCheckbox) {
                clearCheckbox.checked = false;
            }

            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                previewBlock.style.display = "block";
            };
            reader.readAsDataURL(file);
        });
    }

    if (clearBtn) {
        clearBtn.addEventListener("click", () => {
            fileInput.value = "";
            previewBlock.style.display = "none";
        });
    }
});
</script>
{% endblock %}
